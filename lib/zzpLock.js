"use strict";function _classCallCheck(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,s){for(var e=0;e<s.length;e++){var i=s[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(s,e,i){return e&&t(s.prototype,e),i&&t(s,i),s}}();!function(t){var s=null,e=(t.devicePixelRatio,function(){function t(e){if(_classCallCheck(this,t),s)return s;s=this;var i={nodeType:3,width:300,height:300,ifAdapter:1,backColor:"#305066",preColor:"#cfe6ff",afterColor:"#ffa726",fillColor:"#2b4a5f",canvasName:"#canvas",hintName:"#hint",template:'<canvas id="hint" width=100 height=100></canvas><div id="myImage"></div><h4 id="title" class="title">设置解锁图案</h4><canvas id="canvas" width={width} height={height}></canvas><a id="changePsw">设置密码</a>'};Object.assign(this,i,e),this.btnFlag=0,this.lastNodes=[],this.restNodes=[],this.hintNodes=[],this.touchFlag=!1,this.initLock()}return _createClass(t,[{key:"initLock",value:function(){if(this.ifAdapter&&this.adapte(),this.initDom(),this.pswObj=window.localStorage.getItem("lockPsw")?{lockState:2,lockPsw:window.localStorage.getItem("lockPsw")}:{},this.canvas=document.querySelector(this.canvasName),this.canvasHint=document.querySelector(this.hintName),!this.canvas||!this.canvasHint)throw new Error("CANVAS 没有找到");this.cvc=this.canvas.getContext("2d"),this.cvh=this.canvasHint.getContext("2d"),this.r=this.cvc.canvas.width/(2+4*this.nodeType),this.lr=this.r/this.width*100,this.createCircles(),this.changeShow(),this.bindEvents()}},{key:"adapte",value:function(){var t=this,s=window.devicePixelRatio>=2?.5:1,e=window.devicePixelRatio>=2?2:1;this.width=this.width*e,this.height=this.height*e,this.template=this.template.replace(/\{([^{}]+)\}/gm,function(s,e){return t[e]}),console.log(this.template);var i=document.querySelector("meta[name=viewport]");i||(i=document.createElement("meta"),i.setAttribute("name","viewport"),document.head.appendChild(i)),document.querySelector("html").setAttribute("data-ptr",e),i.setAttribute("content","maximum-scale="+s+",minimum-scale="+s+", initial-scale="+s+", user-scalable=no")}},{key:"initDom",value:function(){var t=document.createElement("div"),s=this.template;t.id="canvasWrap",t.style.backgroundColor=this.backColor,t.insertAdjacentHTML("afterbegin",s),document.body.appendChild(t)}},{key:"createCircles",value:function(){var t=this.nodeType,s=0,e=this.r,i=this.lr;this.lastNodes=[],this.arr=[],this.restNodes=[],this.hintNodes=[];for(var h=0;h<t;h++)for(var a=0;a<t;a++){s++;var c={x:4*a*e+3*e,y:4*h*e+3*e,index:s},n={x:4*a*i+3*i,y:4*h*i+3*i,index:s};this.arr.push(c),this.restNodes.push(c),this.hintNodes.push(n)}this.cvc.clearRect(0,0,this.cvc.canvas.width,this.cvc.canvas.height);for(var o=0;o<this.arr.length;o++)this.singleCir(this.arr[o].x,this.arr[o].y)}},{key:"singleCir",value:function(t,s){this.cvc.strokeStyle=this.preColor,this.cvc.fillStyle=this.fillColor,this.cvc.lineWidth=2,this.cvc.beginPath(),this.cvc.arc(t,s,this.r,0,2*Math.PI,!0),this.cvc.closePath(),this.cvc.fill(),this.cvc.stroke()}},{key:"changeShow",value:function(){var t=this.pswObj.lockState;this._showMsg(t),2===t?this.btnFlag=1:1===t?(this.createHint(),this.showHint(),this.btnFlag=1):(this.createHint(),this.btnFlag=0)}},{key:"_showMsg",value:function(t){this.showMsg?this.showMsg(t):console.warn("没有写界面展示的回调函数")}},{key:"createHint",value:function(){var t=this.hintNodes.length;this.cvh.clearRect(0,0,100,100),this.cvh.fillStyle=this.preColor;for(var s=0;s<t;s++)this.cvh.beginPath(),this.cvh.arc(this.hintNodes[s].x,this.hintNodes[s].y,this.lr,0,2*Math.PI,!0),this.cvh.closePath(),this.cvh.fill()}},{key:"showHint",value:function(){var t=void 0,s=this.pswObj.firstPsw,e=this.pswObj.firstPsw.length;this.cvh.fillStyle="#00ff00";for(var i=0;i<e;i++)t=s[i].index,this.cvh.beginPath(),this.cvh.arc(this.hintNodes[t-1].x,this.hintNodes[t-1].y,this.lr,0,2*Math.PI,!0),this.cvh.closePath(),this.cvh.fill()}},{key:"changePsw",value:function(){1===this.btnFlag&&(this.pswObj={},window.localStorage.removeItem("lockPsw"),window.localStorage.removeItem("nodeType"),document.querySelector("#title").textContent="设置解锁图案",this.resetLock())}},{key:"stateCirCol",value:function(t){var s=this.lastNodes.length;this.cvc.strokeStyle=t;for(var e=0;e<s;e++)this.cvc.lineWidth=2,this.cvc.beginPath(),this.cvc.arc(this.lastNodes[e].x,this.lastNodes[e].y,this.r,0,2*Math.PI,!0),this.cvc.closePath(),this.cvc.stroke(),this.cvc.lineWidth=5,this.cvc.beginPath(),this.cvc.arc(this.lastNodes[e].x,this.lastNodes[e].y,this.r/2,0,2*Math.PI,!0),this.cvc.closePath(),this.cvc.stroke();this.drawLines({col:t})}},{key:"pswWork",value:function(){var t=this.pswObj.lockState;if(2===t){this._pswEncript(JSON.stringify(this.pswObj.lockPsw))===this._pswEncript(JSON.stringify(this.lastNodes))?(this.stateCirCol("#00ff00"),this._pwdResultMsg("success")):(this.stateCirCol("#ff0000"),this._pwdResultMsg("error"))}else if(1===t){var s=this._pswEncript(JSON.stringify(this.pswObj.firstPsw)),e=this._pswEncript(JSON.stringify(this.lastNodes));e===s?(this.stateCirCol("#00ff00"),this.pswObj.lockState=2,this.pswObj.lockPsw=this.lastNodes,window.localStorage.setItem("nodeType",this.nodeType),window.localStorage.setItem("lockPsw",s),this._pwdResultMsg("storeSuccess")):(this.stateCirCol("#ff0000"),this._pwdResultMsg("storeError"))}else this.lastNodes.length<5?(this.stateCirCol("#ffa726"),this._pwdResultMsg("shortPwd")):(this.pswObj.firstPsw=this.lastNodes,this.pswObj.lockState=1,this._pwdResultMsg("repeatPwd"))}},{key:"_pswEncript",value:function(t){return this.pswEncript?this.pswEncript(t):(console.wran("无加密算法"),t)}},{key:"_pwdResultMsg",value:function(t){this.pwdResultMsg?this.pwdResultMsg(t):console.warn("没有写提示回调函数")}},{key:"fillCir",value:function(){for(var t=0;t<this.lastNodes.length;t++)this.cvc.strokeStyle=this.preColor,this.cvc.lineWidth=5,this.cvc.beginPath(),this.cvc.arc(this.lastNodes[t].x,this.lastNodes[t].y,this.r/2,0,2*Math.PI,!0),this.cvc.closePath(),this.cvc.stroke()}},{key:"drawLines",value:function(t){var s=t.p,e=t.col;this.cvc.beginPath(),this.cvc.strokeStyle=e||this.preColor,this.cvc.lineWidth=3,this.cvc.moveTo(this.lastNodes[0].x,this.lastNodes[0].y);for(var i=1;i<this.lastNodes.length;i++)this.cvc.lineTo(this.lastNodes[i].x,this.lastNodes[i].y);s&&this.cvc.lineTo(s.x,s.y),this.cvc.stroke(),this.cvc.closePath()}},{key:"update",value:function(t){this.cvc.clearRect(0,0,this.cvc.canvas.width,this.cvc.canvas.height);for(var s=0;s<this.arr.length;s++)this.singleCir(this.arr[s].x,this.arr[s].y);this.fillCir(),this.drawLines({p:t});for(var e=0;e<this.restNodes.length;e++)if(i.isInCircle(t.x,t.y,this.restNodes[e].x,this.restNodes[e].y,this.r)){this.lastNodes.push(this.restNodes[e]),this.restNodes.splice(e,1);break}}},{key:"resetLock",value:function(){this.createCircles(),this.changeShow()}},{key:"bindEvents",value:function(){var t=this;this.canvas.addEventListener("touchstart",function(s){s.preventDefault();for(var e=i.getPosition(s),h=0;h<t.arr.length;h++)if(i.isInCircle(e.x,e.y,t.arr[h].x,t.arr[h].y,t.r)){t.touchFlag=!0,t.fillCir(t.arr[h].x,t.arr[h].y),t.lastNodes.push(t.arr[h]),t.restNodes.splice(h,1);break}},!1),this.canvas.addEventListener("touchmove",function(s){t.touchFlag&&t.update(i.getPosition(s))},!1),this.canvas.addEventListener("touchend",function(s){t.touchFlag&&(t.touchFlag=!1,t.pswWork(),setTimeout(function(){t.resetLock()},400))},!1),document.addEventListener("touchmove",function(t){t.preventDefault()},!1),document.querySelector("#changePsw").addEventListener("click",function(){t.changePsw()},!1)}}]),t}()),i={getPosition:function(t){var s=t.currentTarget.getBoundingClientRect();return{x:t.touches[0].clientX-s.left,y:t.touches[0].clientY-s.top}},isInCircle:function(t,s,e,i,h){var a=Math.pow;return a(t-e,2)+a(s-i,2)<=a(h,2)},checkPsw:function(t,s){for(var e="",i="",h=0;h<t.length;h++)e+=t[h].index;for(var a=0;a<s.length;a++)i+=s[a].index;return e===i}};t.ZZPLock=e}(window);